<canvas id="ctx" width="1300" height="600" style="border:1px solid #000000;"></canvas>

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script>
    const LEFT_KEY_CODE = 37;
    const UP_KEY_CODE = 38;
    const RIGHT_KEY_CODE = 39;
    const DOWN_KEY_CODE = 40;
    const A_KEY_CODE = 65;
    const W_KEY_CODE = 87;
    const D_KEY_CODE = 68;
    const S_KEY_CODE = 83;
    let myPlayer = {};
    let heartDict = {};
    let socket = io();
    let playerDict;
    let projectileDict;
    let mouthOpenFrames = 0;

    document.body.onmousedown = function (event) {
        if (myPlayer.team == 1) {
            let xDirection = (event.x - myPlayer.x);
            let yDirection = (event.y - myPlayer.y);
            let speed = 0.8;
            let xVel = speed * xDirection / (Math.abs(xDirection) + Math.abs(yDirection));
            let yVel = -speed * yDirection / (Math.abs(xDirection) + Math.abs(yDirection));

            let newXVel = xVel * (1 + 0.2 * (speed - Math.abs(Math.abs(xVel) - Math.abs(yVel))));
            let newYVel = yVel * (1 + 0.2 * (speed - Math.abs(Math.abs(xVel) - Math.abs(yVel))));

            mouthOpenFrames = 15;

            socket.emit("shootProjectile", {
                x: myPlayer.x,
                y: myPlayer.y,
                xVelocity: 14 * newXVel,
                yVelocity: -14 * newYVel
            });
        }
    };

    document.onkeydown = function (event) {
        if (event.keyCode === LEFT_KEY_CODE || event.keyCode === A_KEY_CODE) {
            socket.emit("keyPress", { inputId: "left", state: true });
        }
        if (event.keyCode === UP_KEY_CODE || event.keyCode === W_KEY_CODE) {
            socket.emit("keyPress", { inputId: "up", state: true });
        }
        if (event.keyCode === RIGHT_KEY_CODE || event.keyCode === D_KEY_CODE) {
            socket.emit("keyPress", { inputId: "right", state: true });
        }
        if (event.keyCode === DOWN_KEY_CODE || event.keyCode === S_KEY_CODE) {
            socket.emit("keyPress", { inputId: "down", state: true });
        }
    };

    document.onkeyup = function (event) {
        if (event.keyCode === LEFT_KEY_CODE || event.keyCode === A_KEY_CODE) {
            socket.emit("keyPress", { inputId: "left", state: false });
        }
        if (event.keyCode === UP_KEY_CODE || event.keyCode === W_KEY_CODE) {
            socket.emit("keyPress", { inputId: "up", state: false });
        }
        if (event.keyCode === RIGHT_KEY_CODE || event.keyCode === D_KEY_CODE) {
            socket.emit("keyPress", { inputId: "right", state: false });
        }
        if (event.keyCode === DOWN_KEY_CODE || event.keyCode === S_KEY_CODE) {
            socket.emit("keyPress", { inputId: "down", state: false });
        }
    };

    var ctx = document.getElementById("ctx").getContext("2d");
    ctx.font = "30px Arial";

    socket.on("newPlayerPositions", function (data) {
        playerDict = data;
    });

    socket.on("newProjectilePositions", function (data) {
        projectileDict = data;
    });

    socket.on("yourPlayerId", function (id) {
        myPlayer.id = id;
    });

    socket.on("yourPlayerTeam", function (team) {
        myPlayer.team = team;
    });

    socket.on("heartDict", function (heartDictGiven) {// TODO: heartDictGiven should be heartDict
        heartDict = heartDictGiven;
    });

    socket.on("heartHit", function (id) {
        heartDict[id].health--;
    });

    let drawFace = function (player) {
        if (player.team == 1) {
            if (player.id === myPlayer.id && mouthOpenFrames > 0) {
                mouthOpenFrames--;
                ctx.fillText(":o", player.x, player.y);
            } else {
                ctx.fillText(":)", player.x, player.y);
            }
        } else if (player.team == 2) {
            ctx.fillText("_", player.x - 5, player.y - 35);
            ctx.fillText(":)", player.x, player.y);
        } else {
            console.error("Player team should be 1 or 2 (player.team ===", player.team + ")");
        }
    };

    let drawHearts = function () {
        for (let i in heartDict) {
            if (heartDict[i].health) {
                ctx.fillText(heartDict[i].health, heartDict[i].x, heartDict[i].y);
            }
        }
    };

    let updatePlayers = function () {
        for (let i in playerDict) {
            drawFace(playerDict[i]);

            if (playerDict[i].id === myPlayer.id) {
                myPlayer.x = playerDict[i].x;
                myPlayer.y = playerDict[i].y;
            }
        }
    };

    let updateProjectiles = function () {
        for (let i in projectileDict) {

            ctx.fillText("*", projectileDict[i].x, projectileDict[i].y);
        }
    };

    setInterval(function () {
        ctx.clearRect(0, 0, 1300, 600);

        updatePlayers();
        updateProjectiles();
        drawHearts();
    }, 1000 / 160);

</script>